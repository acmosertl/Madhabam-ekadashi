<div id="mmoon" style="max-width:340px"></div>

<script>
(function(){

const API_SS="https://api.sunrise-sunset.org/json";
const API_OM="https://api.open-meteo.com/v1/forecast";
const API_IP="https://ipapi.co/json/";
const DEF={lat:22.57,lon:88.36,src:"‡¶∏‡ßç‡¶•‡¶ø‡¶∞ ‡¶∏‡ßç‡¶•‡¶æ‡¶®‡¶æ‡¶ô‡ßç‡¶ï",city:"Kolkata"};

const bn=n=>String(n).replace(/[0-9]/g,d=>"‡ß¶‡ßß‡ß®‡ß©‡ß™‡ß´‡ß¨‡ß≠‡ßÆ‡ßØ"[d]);
const fmtT=i=>i?new Date(i).toLocaleTimeString("bn-BD",{hour:"2-digit",minute:"2-digit",hour12:true}):"‚Äî";
const fmtD=i=>i?new Date(i).toLocaleDateString("bn-BD",{day:"2-digit",month:"2-digit",year:"numeric"}):"‚Äî";

function phase(){
 let now=new Date();
 const ep=Date.UTC(2000,0,6,18,14,0);
 const syn=29.530588853;
 const age=((now-ep)% (syn*864e5)+syn*864e5)% (syn*864e5)/864e5;
 const ang=2*Math.PI*(age/syn);
 const illum=Math.round((1-Math.cos(ang))/2*100);
 let name="",pak="";
 if(age<1){name="‡¶Ö‡¶Æ‡¶æ‡¶¨‡¶∏‡ßç‡¶Ø‡¶æ";pak="‡¶∂‡ßÅ‡¶ï‡ßç‡¶≤‡¶™‡¶ï‡ßç‡¶∑";}
 else if(age<7.4){name="‡¶¨‡¶∞‡ßç‡¶ß‡¶Æ‡¶æ‡¶® ‡¶Ö‡¶∞‡ßç‡¶ß‡¶ö‡¶®‡ßç‡¶¶‡ßç‡¶∞";pak="‡¶∂‡ßÅ‡¶ï‡ßç‡¶≤‡¶™‡¶ï‡ßç‡¶∑";}
 else if(age<14.77){name="‡¶¨‡¶∞‡ßç‡¶ß‡¶Æ‡¶æ‡¶® ‡¶ó‡¶ø‡¶≠‡¶æ‡¶∏";pak="‡¶∂‡ßÅ‡¶ï‡ßç‡¶≤‡¶™‡¶ï‡ßç‡¶∑";}
 else if(age<15.77){name="‡¶™‡ßÇ‡¶∞‡ßç‡¶£‡¶ø‡¶Æ‡¶æ";pak="‡¶ï‡ßÉ‡¶∑‡ßç‡¶£‡¶™‡¶ï‡ßç‡¶∑";}
 else if(age<22.1){name="‡¶ï‡ßç‡¶∑‡¶Ø‡¶º‡¶Æ‡¶æ‡¶® ‡¶ó‡¶ø‡¶≠‡¶æ‡¶∏";pak="‡¶ï‡ßÉ‡¶∑‡ßç‡¶£‡¶™‡¶ï‡ßç‡¶∑";}
 else{name="‡¶π‡ßç‡¶∞‡¶∏‡ßç‡¶¨ ‡¶Ö‡¶∞‡ßç‡¶ß‡¶ö‡¶®‡ßç‡¶¶‡ßç‡¶∞";pak="‡¶ï‡ßÉ‡¶∑‡ßç‡¶£‡¶™‡¶ï‡ßç‡¶∑";}
 const nextF=new Date(now.getTime()+(((14.765294-age+syn)%syn)*864e5));
 const nextN=new Date(now.getTime()+(((syn-age)%syn)*864e5));
 return {age,illum,name,pak,nextF,nextN};
}

async function loc(){
 try{
   if(navigator.geolocation){
     let p=await new Promise((r,j)=>navigator.geolocation.getCurrentPosition(r,j,{timeout:2e3}));
     return {lat:p.coords.latitude,lon:p.coords.longitude,src:"GPS",city:"GPS Location"};
   }
 }catch(e){}
 try{
   const r=await fetch(API_IP); const j=await r.json();
   return {lat:j.latitude,lon:j.longitude,src:"IP",city:j.city||"IP Location"};
 }catch(e){}
 return DEF;
}

async function moon(lat,lon){
 let ri=null,se=null;
 try{
   let r=await fetch(`${API_SS}?lat=${lat}&lng=${lon}&date=today&formatted=0`);
   let j=await r.json();
   if(j.status=="OK"){ ri=j.results.moonrise; se=j.results.moonset; }
 }catch(e){}
 if(!ri||!se){
   try{
     let r=await fetch(`${API_OM}?latitude=${lat}&longitude=${lon}&daily=moonrise,moonset&timezone=auto`);
     let j=await r.json();
     let t=new Date().toISOString().slice(0,10);
     if(j.daily){
       if(!ri && j.daily.moonrise[0]) ri=t+"T"+j.daily.moonrise[0];
       if(!se && j.daily.moonset[0]) se=t+"T"+j.daily.moonset[0];
     }
   }catch(e){}
 }
 return {rise:fmtT(ri),set:fmtT(se)};
}

function moonSVG(age){
 const syn=29.530588853,p=(age%syn)/syn,shift=Math.round((p-0.5)*36);
 return `
 <svg viewBox="0 0 100 100" width="56" height="56" xmlns="http://www.w3.org/2000/svg">
   <defs><clipPath id="c"><circle cx="50" cy="50" r="45"/></clipPath></defs>
   <circle cx="50" cy="50" r="45" fill="#233E9B"></circle>
   <g clip-path="url(#c)">
     <ellipse cx="${50-shift}" cy="50" rx="20" ry="40" fill="#FFD23F"></ellipse>
   </g>
 </svg>`;
}

function UI(){
 const r=document.getElementById("mmoon");
 r.innerHTML=`
 <style>
  #mmoon *{font-family:'Noto Sans Bengali','Kalpurush',sans-serif;}
  .card{background:#fff;padding:14px;border-radius:12px;box-shadow:0 5px 18px #0002;}
  .h{display:flex;gap:10px;color:#5D4037;font-size:20px;font-weight:800;margin-bottom:10px}
  .sep{border-bottom:1px dashed #ccc;margin-bottom:10px}
  .row{display:flex;justify-content:space-between;margin:6px 0;font-size:16px}
  .panel{background:#eaf3ff;padding:12px;border-radius:10px;margin-top:10px}
  .full{background:#1e3a8a;color:#fff;padding:12px;border-radius:10px;margin-top:10px}
  .full .l{color:#ffd84d;font-weight:900}
  .loc{text-align:right;font-size:14px;color:#666;margin-top:10px}
 </style>

 <div class="card">
   <div class="h"><span>üåô</span><span id="t1"></span></div>
   <div class="sep"></div>

   <div class="row"><span id="l1"></span><span id="v1"></span></div>
   <div class="row"><span id="l2"></span><span id="v2"></span></div>

   <div class="panel">
     <div style="display:flex;gap:12px;align-items:center">
        <div id="mblob"></div>
        <div>
          <div id="phase" style="font-weight:800;color:#222"></div>
          <div id="illum" style="margin-top:6px;font-weight:700;color:#444"></div>
        </div>
     </div>
     <div class="full">
       <div class="l" id="llabel"></div>
       <div id="f1" style="margin-top:8px"></div>
       <div id="f2" style="margin-top:6px"></div>
     </div>
   </div>

   <div class="loc" id="loc"></div>
 </div>
 `;
}

async function run(){
 UI();

 document.getElementById("t1").textContent="‡¶ö‡¶®‡ßç‡¶¶‡ßç‡¶∞ ‡¶∏‡¶Æ‡ßü ‡¶ì ‡¶™‡¶∞‡ßç‡¶Ø‡¶æ‡ßü";
 document.getElementById("l1").textContent="‡¶ö‡¶®‡ßç‡¶¶‡ßç‡¶∞‡ßã‡¶¶‡¶Ø‡¶º:";
 document.getElementById("l2").textContent="‡¶ö‡¶®‡ßç‡¶¶‡ßç‡¶∞‡¶æ‡¶∏‡ßç‡¶§:";
 document.getElementById("llabel").textContent="‡¶™‡¶∞‡¶¨‡¶∞‡ßç‡¶§‡ßÄ:";

 const L=await loc();
 const M=await moon(L.lat,L.lon);
 const P=phase();

 document.getElementById("v1").textContent=M.rise;
 document.getElementById("v2").textContent=M.set;
 document.getElementById("phase").textContent=`‡¶™‡¶∞‡ßç‡¶Ø‡¶æ‡¶Ø‡¶º: ${P.name} (${P.pak})`;
 document.getElementById("illum").textContent=`‡¶Ü‡¶≤‡ßã‡¶ï‡¶Æ‡¶æ‡¶§‡ßç‡¶∞‡¶æ: ${bn(P.illum)}%`;
 document.getElementById("f1").textContent=`‡¶™‡ßÇ‡¶∞‡ßç‡¶£‡¶ø‡¶Æ‡¶æ: ${fmtD(P.nextF)}`;
 document.getElementById("f2").textContent=`‡¶Ö‡¶Æ‡¶æ‡¶¨‡¶∏‡ßç‡¶Ø‡¶æ: ${fmtD(P.nextN)}`;
 document.getElementById("loc").textContent=`‡¶∏‡ßç‡¶•‡¶æ‡¶® ‡¶∏‡ßÇ‡¶§‡ßç‡¶∞: ${L.src} | ${L.city}`;
 document.getElementById("mblob").innerHTML=moonSVG(P.age);
}

run();
setInterval(run,1800000);

})();
     </script>
